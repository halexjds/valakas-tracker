<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Status Valakas</title>
  <style>
    body {
      background: url('valakas.png') no-repeat center center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
      color: #fff;
      text-align: center;
      padding-top: 50px;
    }
    h1 {
      font-size: 2.5em;
      text-shadow: 2px 2px 6px #000;
    }
    .timer { 
      font-size: 2em; 
      margin: 20px; 
    }
    button { 
      padding: 10px 20px; 
      font-size: 16px; 
      cursor: pointer; 
      margin: 10px; 
      border-radius: 8px;
      border: none;
      background: #b30000;
      color: #fff;
      transition: 0.3s;
    }
    button:hover {
      background: #ff3333;
      transform: scale(1.05);
    }
    .status { 
      margin-top: 20px; 
      font-size: 14px; 
      color: #ffb84d; 
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 10px auto;
      width: fit-content;
      text-align: left;
    }
    li {
      margin: 5px 0;
      font-size: 15px;
      text-shadow: 1px 1px 3px #000;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ================================
    // CONFIGURA√á√ÉO FIREBASE
    // ================================
    const firebaseConfig = {
      apiKey: "AIzaSyCRh9VfLtflFK69QaAyxWrS9opktAn7Vo8",
      authDomain: "valakas-tracker.firebaseapp.com",
      projectId: "valakas-tracker",
      storageBucket: "valakas-tracker.firebasestorage.app",
      messagingSenderId: "1073176685323",
      appId: "1:1073176685323:web:621c3fb91d03053cad900e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const bossDoc = doc(db, "bosses", "valakas");

    // ================================
    // CONFIGURA√á√ïES DO RESPAWN
    // ================================
    const antiSpamMode = 1; // 1 = ativo, 0 = desativado
    const minRespawn = 11 * 24 * 60 * 60 * 1000;
    const maxRespawn = 17 * 24 * 60 * 60 * 1000;

    // ================================
    // REGISTRAR MORTE
    // ================================
    async function registerDeath() {
      const snap = await getDoc(bossDoc);
      const now = new Date();

      if (antiSpamMode === 1 && snap.exists()) {
        const nextSpawn = snap.data().nextSpawn.toDate();
        if (now < nextSpawn) {
          alert("‚ö†Ô∏è Anti-spam ativo: j√° h√° um registro v√°lido at√© o pr√≥ximo spawn.");
          return;
        }
      }

      const respawnTime = minRespawn + Math.random() * (maxRespawn - minRespawn);
      const nextSpawn = new Date(now.getTime() + respawnTime);

      await setDoc(bossDoc, {
        lastDeath: now,
        nextSpawn: nextSpawn,
        reporter: "Usu√°rio manual",
        antiSpamActive: antiSpamMode
      });

      alert("‚úÖ Morte registrada! Novo spawn entre 11 e 17 dias.");
      updateTimer();
    }

    // ================================
// ATUALIZAR CONTAGEM E FUSOS (JANELAS DUPLAS)
// ================================
async function updateTimer() {
  const snap = await getDoc(bossDoc);
  const timerEl = document.getElementById("timer");
  const fusoEl = document.getElementById("fusoAtual");
  const listaFusosEl = document.getElementById("listaFusos");

  if (!snap.exists()) {
    timerEl.textContent = "Nenhum registro ainda.";
    return;
  }

  const data = snap.data();
  const lastDeath = data.lastDeath.toDate();
  const spawnMin = new Date(lastDeath.getTime() + minRespawn);
  const spawnMax = new Date(lastDeath.getTime() + maxRespawn);

  // Lista fixa de fusos
  const fusos = [
    "America/Sao_Paulo",
    "America/New_York",
    "Europe/London",
    "Europe/Paris",
    "Europe/Moscow",
    "Asia/Seoul",
    "Asia/Tokyo",
    "Asia/Shanghai",
    "Australia/Sydney"
  ];

  // Atualiza contador principal e fusos
  const interval = setInterval(() => {
    const now = new Date();
    const diffMin = spawnMin - now;
    const diffMax = spawnMax - now;

    if (diffMax <= 0) {
      timerEl.innerHTML = "üî• Valakas pode estar vivo!";
      clearInterval(interval);
      return;
    }

    // Mostra as duas janelas
    const { days: dMin, hours: hMin, mins: mMin, secs: sMin } = timeDiff(diffMin);
    const { days: dMax, hours: hMax, mins: mMax, secs: sMax } = timeDiff(diffMax);

    timerEl.innerHTML = `
      üî∫ <b>Janela M√°xima (17d):</b> ${dMax}d ${hMax}h ${mMax}m ${sMax}s<br>
      üîª <b>Janela M√≠nima (11d):</b> ${dMin}d ${hMin}h ${mMin}m ${sMin}s
    `;

    // Atualiza lista de fusos
    listaFusosEl.innerHTML = fusos.map(f => {
      const fusoDateMin = new Date(spawnMin.toLocaleString("en-US", { timeZone: f }));
      const fusoDateMax = new Date(spawnMax.toLocaleString("en-US", { timeZone: f }));

      const diffMinFuso = fusoDateMin - now;
      const diffMaxFuso = fusoDateMax - now;

      const { days: dMinF, hours: hMinF, mins: mMinF, secs: sMinF } = timeDiff(diffMinFuso);
      const { days: dMaxF, hours: hMaxF, mins: mMaxF, secs: sMaxF } = timeDiff(diffMaxFuso);

      return `
        <li>
          üêâ <b>${f.replace("_", " ")}</b><br>
          üî∫ M√°x: ${dMaxF}d ${hMaxF}h ${mMaxF}m ${sMaxF}s restantes<br>
          üîª M√≠n: ${dMinF}d ${hMinF}h ${mMinF}m ${sMinF}s restantes
        </li>`;
    }).join("");
  }, 1000);

  // Fuso local
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  fusoEl.textContent = `üïì Fuso hor√°rio local: ${timezone}`;

  document.getElementById("status").textContent =
    `Anti-spam: ${antiSpamMode === 1 ? "üü¢ Ativado" : "üî¥ Desativado"}`;
}

    // ================================
    // FUN√á√ïES AUXILIARES
    // ================================
    function timeDiff(diff) {
      return {
        days: Math.floor(diff / (1000 * 60 * 60 * 24)),
        hours: Math.floor((diff / (1000 * 60 * 60)) % 24),
        mins: Math.floor((diff / (1000 * 60)) % 60),
        secs: Math.floor((diff / 1000) % 60)
      };
    }

    function formatDate(date, tz) {
      return new Intl.DateTimeFormat("pt-BR", {
        timeZone: tz,
        dateStyle: "short",
        timeStyle: "medium"
      }).format(date);
    }

    window.onload = updateTimer;
    window.registerDeath = registerDeath;
  </script>
</head>
<body>
  <h1>üéÆüî• Status Valakas üî•üéÆ</h1>
  <div id="timer" class="timer">Carregando...</div>
  <button onclick="registerDeath()">Registrar morte</button>
  <div id="status" class="status">Anti-spam: carregando...</div>

  <h3 id="fusoAtual"></h3>
  <h3>‚è∞ Hor√°rios equivalentes de spawn:</h3>
  <ul id="listaFusos"></ul>
</body>
</html>
