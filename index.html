<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Valakas Tracker Online</title>
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    text-align: center;
    background: url('valakas.png') no-repeat center center fixed;
    background-size: cover;
    color: #eee;
    margin: 0; padding: 30px;
  }
  h1 {
    color: #ff4d4d;
    text-shadow: 0 0 15px #ff0000aa;
    background: rgba(0,0,0,0.5);
    display: inline-block;
    padding: 10px 20px;
    border-radius: 12px;
  }
  #timer, label, footer, input, button {
    background: rgba(0,0,0,0.5);
    border-radius: 10px;
  }
  input, button {
    padding: 10px;
    margin: 10px;
    border: none;
    font-size: 1em;
    color: #fff;
  }
  button {
    background: #ff4d4d;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover {
    background: #ff6666;
  }
  #muteBtn {
    background: #333;
    color: #eee;
    margin-left: 10px;
  }
  #muteBtn.muted {
    background: #555;
    color: #ffcc00;
  }
  #timer {
    font-size: 2em;
    margin-top: 30px;
    padding: 15px;
  }
  .alert {
    color: #ffcc00;
    font-weight: bold;
  }
  footer {
    margin-top: 60px;
    font-size: 0.9em;
    color: #ccc;
    background: rgba(0,0,0,0.4);
    display: inline-block;
    padding: 5px 15px;
    border-radius: 10px;
  }
</style>

</head>
<body>
  <h1>üî• Valakas Tracker Online üî•</h1>

  <div>
    <button id="deathBtn">üêâ Valakas morto agora</button>
    <button id="muteBtn">üîä Som Ligado</button>
  </div>

  <div id="timer">Carregando...</div>
  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script type="module">
  // Import modular SDK (vers√£o est√°vel; ajuste se houver vers√£o nova)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // ----- INSIRA AQUI SUA CONFIGURA√á√ÉO DO FIREBASE -----
  const firebaseConfig = {
  apiKey: "AIzaSyCRh9VfLtflFK69QaAyxWrS9opktAn7Vo8",
  authDomain: "valakas-tracker.firebaseapp.com",
  projectId: "valakas-tracker",
  storageBucket: "valakas-tracker.firebasestorage.app",
  messagingSenderId: "1073176685323",
  appId: "1:1073176685323:web:621c3fb91d03053cad900e"
};
  // ---------------------------------------------------

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Autentica anonimamente (se ainda n√£o autentica)
  signInAnonymously(auth).catch((err) => {
    console.error("Erro ao autenticar anonimamente:", err);
    alert("Erro de autentica√ß√£o Firebase. Veja console.");
  });

  // Refer√™ncia ao documento bosses/valakas
  const docRef = doc(db, "bosses", "valakas");

  // Elementos da UI
  const deathBtn = document.getElementById("deathBtn");
  const timerDiv = document.getElementById("timer");
  const alarm = document.getElementById("alarmSound");
  const muteBtn = document.getElementById("muteBtn");
  let intervalId;

  // Estado de mute persistido
  const mutedSaved = localStorage.getItem("valakasMuted") === "true";
  setMuted(mutedSaved);

  // Quando o usu√°rio clica "Valakas morto agora"
  deathBtn.onclick = async () => {
    // garante que esteja autenticado
    if (!auth.currentUser) {
      alert("Aguardando autentica√ß√£o... tente novamente em 1‚Äì2s.");
      return;
    }
    try {
      // grava timestamp do servidor (coerente para todos)
      await setDoc(docRef, { deathTime: serverTimestamp() }, { merge: true });
    } catch (err) {
      console.error("Erro ao gravar deathTime:", err);
      alert("Erro ao enviar a hora. Veja console.");
    }
  };

  // Ouve atualiza√ß√µes em tempo real no documento
  onSnapshot(docRef, (snapshot) => {
    if (!snapshot.exists()) {
      timerDiv.textContent = "Nenhuma entrada ainda. Clique em 'Valakas morto agora' para registrar.";
      return;
    }
    const data = snapshot.data();
    const t = data.deathTime;
    if (!t) {
      timerDiv.textContent = "Registro presente, aguardando timestamp do servidor...";
      return;
    }
    const deathTime = t.toDate(); // Timestamp -> Date
    startTimer(deathTime);
  }, (err) => {
    console.error("onSnapshot erro:", err);
    timerDiv.textContent = "Erro ao conectar ao Firestore. Veja console.";
  });

  // Inicia contador a partir do deathTime (mesma l√≥gica: +11h / +17h)
  function startTimer(deathTime) {
    clearInterval(intervalId);
    const spawnMin = new Date(deathTime.getTime() + 11 * 60 * 60 * 1000);
    const spawnMax = new Date(deathTime.getTime() + 17 * 60 * 60 * 1000);

    function tick() {
      const now = new Date();
      const diff = spawnMin - now;
      if (diff <= 0) {
        timerDiv.innerHTML = `üêâ <b>Valakas pode nascer a qualquer momento!</b><br><span style="color:#ffcc00">Janela at√© ${spawnMax.toLocaleTimeString()}</span>`;
        if (!alarm.muted && alarm.paused) alarm.play();
        return;
      }
      const h = Math.floor(diff / (1000*60*60));
      const m = Math.floor((diff % (1000*60*60)) / (1000*60));
      const s = Math.floor((diff % (1000*60)) / 1000);
      timerDiv.innerHTML = `‚è≥ Pr√≥ximo spawn em: ${h}h ${m}m ${s}s<br>(Janela: ${spawnMin.toLocaleTimeString()} ‚Äî ${spawnMax.toLocaleTimeString()})`;
    }
    tick();
    intervalId = setInterval(tick, 1000);
  }

  // Mute logic
  muteBtn.onclick = () => {
    const newMuted = !alarm.muted;
    setMuted(newMuted);
    localStorage.setItem("valakasMuted", newMuted);
  };

  function setMuted(muted) {
    alarm.muted = muted;
    if (muted) {
      muteBtn.textContent = "üîá Som Desligado";
      muteBtn.classList.add("muted");
    } else {
      muteBtn.textContent = "üîä Som Ligado";
      muteBtn.classList.remove("muted");
    }
  }

  // opcional: mostra quando o usu√°rio est√° autenticado
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // user.uid dispon√≠vel
      console.log("Autenticado:", user.uid);
    } else {
      console.log("Usu√°rio n√£o autenticado.");
    }
  });

</script>
</body>
</html>
